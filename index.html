<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úíÔ∏è Minimalist Quiz</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .quiz-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .quiz-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .quiz-title {
            color: #4a5568;
            font-size: 2.5em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .quiz-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
        }

        .question-container {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: linear-gradient(to right, #f8fafc, #ffffff);
            transition: all 0.3s ease;
        }

        .question-container:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

        .question-details {
            width: 100%;
        }

        .question-summary {
            cursor: pointer;
            outline: none;
            padding: 0;
        }

        .question-summary::-webkit-details-marker {
            display: none;
        }

        .question-summary::before {
            /* content: '‚ñ∂'; */
            display: inline-block;
            margin-right: 10px;
            transition: transform 0.3s ease;
            color: #667eea;
            font-size: 0.8em;
        }

        .question-details[open] .question-summary::before {
            transform: rotate(90deg);
        }

        .question-content {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .audio-placeholder {
            min-height: 20px;
        }
        
        .image-placeholder {
            min-height: 20px;
        }

        .question-text {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .question-transcript {
            margin-bottom: 15px;
        }

        .question-transcript summary {
            cursor: pointer;
            color: #4a5568;
            font-weight: 600;
        }

        .transcript-body {
            margin-top: 8px;
            color: #2d3748;
            white-space: pre-wrap;
        }

        .options {
            display: grid;
            gap: 10px;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .option:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .option input[type="radio"] {
            margin-right: 12px;
            scale: 1.2;
        }

        .option.correct {
            background: #c6f6d5;
            border-color: #38a169;
        }

        .option.incorrect {
            background: #fed7d7;
            border-color: #e53e3e;
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Confirmation Dialog Styles */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .dialog {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
        }

        .dialog h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .dialog p {
            color: #4a5568;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .dialog-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .dialog-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.2s ease;
            min-width: 120px;
        }

        .dialog-btn.primary {
            background: #667eea;
            color: white;
        }

        .dialog-btn.primary:hover {
            background: #5a67d8;
        }

        .dialog-btn.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .dialog-btn.secondary:hover {
            background: #cbd5e0;
        }

        .dialog-btn.danger {
            background: #e53e3e;
            color: white;
        }

        .dialog-btn.danger:hover {
            background: #c53030;
        }

        .dialog-btn.success {
            background: #38a169;
            color: white;
        }

        .dialog-btn.success:hover {
            background: #2f855a;
        }

        .results {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .score {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .file-input {
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            text-align: center;
        }

        input[type="file"] {
            margin-top: 10px;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .quiz-container {
                padding: 20px;
            }

            .quiz-title {
                font-size: 2em;
            }

            .quiz-stats {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="quiz-container">
        <div class="quiz-header">
            <h1 class="quiz-title">‚úíÔ∏è Minimalist Quiz</h1>
        </div>

        <details class="file-input" open>
            <summary class="">
                <div class="question-text">
                    Select Quiz
                </div>
            </summary>
            <label for="baseDomain">
                <strong>Base Domain for Media Files:</strong><br>
                <input type="text" id="baseDomain" placeholder=".com" value=".com" style="width: 200px; padding: 8px; border: 2px solid #e2e8f0; border-radius: 5px; margin-bottom: 15px;" />
            </label>
            <br>
            <label for="jsonFile">
                <strong>Load Quiz Questions (JSON file):</strong><br>
                <input type="file" id="jsonFile" accept=".json" />
            </label>

            <div style="margin-top: 12px;">
                <button id="togglePasteBtn" class="dialog-btn secondary" style="padding: 8px 16px; font-size: 0.9em;">Paste JSON instead</button>
            </div>

            <div id="pasteJsonContainer" class="file-input" style="display: none; margin-top: 12px; text-align: left;">
                <label for="pastedJson"><strong>Paste JSON here:</strong></label>
                <textarea id="pastedJson" placeholder="{ \"1\": [ { ...question objects... } ] }" style="width: 100%; min-height: 140px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; resize: vertical;"></textarea>
                <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                    <button id="validateLoadPastedBtn" class="dialog-btn primary">Validate & Load</button>
                    <button id="cancelPasteBtn" class="dialog-btn secondary">Cancel</button>
                </div>
                <div id="pasteHint" style="margin-top: 8px; color: #4a5568; font-size: 0.9em;">Max size: 200 KB. Must look like an object or array.</div>
            </div>

            <div id="setSelection" class="file-input" style="display: none;">
                <label for="quizSet">
                    <strong>Select Quiz Set:</strong><br>
                    <select id="quizSet" style="width: 200px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 5px; font-size: 16px;">
                        <option value="">Choose a set...</option>
                    </select>
                </label>
                <br>
                <label style="display: inline-flex; align-items: center; gap: 8px; margin-top: 6px;">
                    <input type="checkbox" id="practiceMode" />
                    <span><strong>Practice mode</strong></span>
                </label>
                <br>
                <button onclick="loadSelectedSet()" class="submit-btn" style="margin-top: 15px;">Load Quiz Set</button>
            </div>
        </details>

        <div id="quizContent" style="display: none;">
            <div class="quiz-stats">
                <!-- <div><strong>Questions:</strong> <span id="totalQuestions">0</span></div> -->
                <div><strong>Progress:</strong> <span id="progress">Not started</span></div>
                <div>
                    <button id="exportProgressBtn" class="dialog-btn secondary" style="padding: 8px 16px; font-size: 0.9em;" onclick="showExportDialog()" disabled>
                        Export Progress
                    </button>
                </div>
            </div>

            <form id="quizForm">
                <div id="questionsContainer"></div>
                <button type="submit" class="submit-btn" id="submitBtn">Submit Quiz</button>
            </form>

            <div id="results" class="results" style="display: none;">
                <div class="score" id="finalScore"></div>
                <div id="scoreMessage"></div>
                <button onclick="resetQuiz()" class="submit-btn" style="margin-top: 15px;">Take Quiz Again</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div id="confirmationDialog" class="dialog-overlay">
        <div class="dialog">
            <h3 id="dialogTitle">‚ö†Ô∏è Unsaved Progress</h3>
            <p id="dialogMessage">You have unsaved quiz progress. Are you sure you want to leave? You will lose your current answers.</p>
            <div class="dialog-buttons">
                <button class="dialog-btn success" id="exportBtn">üíæ Export & Leave</button>
                <button class="dialog-btn primary" id="stayBtn">Stay</button>
                <button class="dialog-btn danger" id="leaveBtn">‚ö†Ô∏è Discard progress</button>
            </div>
        </div>
    </div>

    <!-- Export JSON Dialog -->
    <div id="exportDialog" class="dialog-overlay">
        <div class="dialog" style="max-width: 700px; text-align: left;">
            <h3>Export Quiz Progress (JSON)</h3>
            <p style="margin-bottom: 10px;">Review and save your progress JSON below</p>
            <textarea id="exportJsonText" style="width: 100%; min-height: 240px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; resize: vertical; font-family: monospace; font-size: 0.95em;"></textarea>
            <div class="dialog-buttons" style="margin-top: 15px; justify-content: flex-end;">
                <button class="dialog-btn secondary" id="exportCopyBtn">Copy</button>
                <button class="dialog-btn primary" id="exportDownloadBtn">Download JSON</button>
                <button class="dialog-btn" id="exportCloseBtn">Close</button>
            </div>
        </div>
    </div>

    <script>
        let quizData = [];
        let userAnswers = {};
        let fullQuizData = {};
        let baseDomain = '';
        let quizStarted = false;
        let pendingNavigation = null;

        document.getElementById('jsonFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/json') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        loadQuizSets(data);
                    } catch (error) {
                        alert('Invalid JSON file. Please check the file format.');
                        console.error('JSON parsing error:', error);
                    }
                };
                reader.readAsText(file);
            } else {
                alert('Please select a valid JSON file.');
            }
        });

        // Read JSON from Textarea
        const pasteToggleBtn = document.getElementById('togglePasteBtn');
        const pasteContainer = document.getElementById('pasteJsonContainer');
        const pasteTextarea = document.getElementById('pastedJson');
        const validateLoadPastedBtn = document.getElementById('validateLoadPastedBtn');
        const cancelPasteBtn = document.getElementById('cancelPasteBtn');

        function togglePasteArea(show) {
            if (typeof show === 'boolean') {
                pasteContainer.style.display = show ? 'block' : 'none';
            } else {
                pasteContainer.style.display = pasteContainer.style.display === 'none' ? 'block' : 'none';
            }
            if (pasteContainer.style.display === 'block') {
                pasteTextarea.focus();
            }
        }

        function basicJsonShapeIsValid(text) {
            if (!text) return false;
            const trimmed = text.trim();
            if (trimmed.length === 0) return false;
            const maxChars = 200 * 1024; // 200 KB guardrail for static page
            if (trimmed.length > maxChars) {
                alert('Pasted text is too large (over 200 KB). Please use a file instead.');
                return false;
            }
            const first = trimmed[0];
            const last = trimmed[trimmed.length - 1];
            const looksLikeJson = (first === '{' && last === '}') || (first === '[' && last === ']');
            if (!looksLikeJson) {
                alert('The pasted text does not look like JSON (must start with { or [ and end with } or ]).');
                return false;
            }
            return true;
        }

        pasteToggleBtn.addEventListener('click', function(e) {
            e.preventDefault();
            togglePasteArea();
        });

        cancelPasteBtn.addEventListener('click', function(e) {
            e.preventDefault();
            pasteTextarea.value = '';
            togglePasteArea(false);
        });

        validateLoadPastedBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const text = pasteTextarea.value;
            if (!basicJsonShapeIsValid(text)) return;
            try {
                const data = JSON.parse(text);
                loadQuizSets(data);
                // hide paste UI after successful load
                togglePasteArea(false);
            } catch (error) {
                alert('Invalid JSON text. Please check the format.');
                console.error('JSON parsing error (pasted):', error);
            }
        });

        function loadQuizSets(data) {
            baseDomain = document.getElementById('baseDomain').value.trim();
            if (!baseDomain) {
                alert('Please enter a base domain first.');
                return;
            }

            // Ensure domain starts with http/https
            if (!baseDomain.startsWith('http://') && !baseDomain.startsWith('https://')) {
                baseDomain = 'https://' + baseDomain;
            }

            fullQuizData = data;

            // Populate the set selection dropdown
            const setSelect = document.getElementById('quizSet');
            setSelect.innerHTML = '<option value="">Choose a set...</option>';

            Object.keys(data).forEach(setId => {
                const option = document.createElement('option');
                option.value = setId;
                option.textContent = `Quiz Set ${setId} (${data[setId].length} questions)`;
                setSelect.appendChild(option);
            });

            document.getElementById('setSelection').style.display = 'block';
        }

        function loadSelectedSet() {
            const selectedSet = document.getElementById('quizSet').value;
            if (!selectedSet) {
                alert('Please select a quiz set.');
                return;
            }

            quizData = fullQuizData[selectedSet];

            if (!quizData || quizData.length === 0) {
                alert('No questions found in the selected set.');
                return;
            }

            displayQuiz();
            // document.getElementById('setSelection').style.display = 'none';
        }

        function displayQuiz() {
            const container = document.getElementById('questionsContainer');
            // const totalQuestionsSpan = document.getElementById('totalQuestions');

            container.innerHTML = '';
            userAnswers = {};
            quizStarted = true;
            const practiceModeEnabled = !!document.getElementById('practiceMode') && document.getElementById('practiceMode').checked;

            // totalQuestionsSpan.textContent = quizData.length;
            document.getElementById('progress').textContent = `0 of ${quizData.length} answered`;

            quizData.forEach((q, index) => {
                const questionDiv = document.createElement('details');
                questionDiv.className = 'question-container .question-details';
                // Create a unique ID for this question's audio container
                const audioContainerId = `audio-container-${q.id || index}`;
                const imageContainerId = `image-container-${q.id || index}`;

                function formatInfoValue(value) {
                    if (value === null || value === undefined) return '' + value;
                    if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {
                        return String(value);
                    }
                    try {
                        return JSON.stringify(value);
                    } catch (e) {
                        return String(value);
                    }
                }

                let infoHTML = '';
                if (practiceModeEnabled) {
                    const excludedKeys = new Set(['id', 'question', 'correct', 'audio_url', 'image_url', 'options', 'transcript']);
                    const additionalEntries = Object.entries(q).filter(([key]) => !excludedKeys.has(key));
                    const additionalDetails = additionalEntries.map(([key, value]) => {
                        const pretty = formatInfoValue(value)
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .trim();
                        return `<details class="question-transcript"><summary><strong>${key}</strong></summary><div class="transcript-body" style="white-space: pre-wrap;">${pretty}</div></details>`;
                    }).join('');

                    const correctValue = (q && 'correct' in q) ? q.correct : '';
                    infoHTML = `<details class="question-transcript"><summary><strong>Information</strong></summary><div class="transcript-body"><div><strong>Correct:</strong> ${correctValue}</div>${additionalDetails}</div></details>`;
                }

                questionDiv.innerHTML = `
                    <summary class="question-summary">
                        <div class="question-text">
                            <strong>Question ${index + 1}:</strong> ${q.question}
                        </div>
                    </summary>
                    ${q.audio_url ? `<div id="${audioContainerId}" class="audio-placeholder" data-audio-url="${baseDomain + q.audio_url}"></div>` : ''}
                    ${q.image_url ? `<div id="${imageContainerId}" class="image-placeholder" data-image-url="${baseDomain + q.image_url}"></div>` : ''}
                    <div class="options">
                        ${q.options.map((option, optIndex) => `
                            <label class="option" for="q${q.id || index}_opt${optIndex}">
                                <input type="radio"
                                       id="q${q.id || index}_opt${optIndex}"
                                       name="question_${q.id || index}"
                                       value="${optIndex}"
                                       onchange="updateProgress()">
                                <span>${option}</span>
                            </label>
                        `).join('')}
                    </div>
                    <details class="question-transcript">
                        <summary><strong>Transcript</strong></summary>
                        <div class="transcript-body">${q.transcript}</div>
                    </details>
                    ${infoHTML}
                `;

                // Add event listener for lazy loading media
                const audioContainer = questionDiv.querySelector(`#${audioContainerId}`);
                const imageContainer = questionDiv.querySelector(`#${imageContainerId}`);

                questionDiv.addEventListener('toggle', function() {
                    if (this.open) {
                        // Lazy load audio
                        if (audioContainer && audioContainer.classList.contains('audio-placeholder')) {
                            const audioUrl = audioContainer.dataset.audioUrl;
                            audioContainer.innerHTML = `
                                <div style="margin-bottom: 15px;">
                                    <audio controls style="width: 100%;">
                                        <source src="${audioUrl}" type="audio/mp3">
                                        <source src="${audioUrl.replace('.mp3', '.ogg')}" type="audio/ogg">
                                        Your browser does not support the audio element.
                                    </audio>
                                </div>
                            `;
                            audioContainer.classList.remove('audio-placeholder');
                        }

                        // Lazy load image
                        if (imageContainer && imageContainer.classList.contains('image-placeholder')) {
                            const imageUrl = imageContainer.dataset.imageUrl;
                            console.log(`Loading image for question ID: ${q.id || index}`);
                            
                            const img = new Image();
                            img.onload = function() {
                                imageContainer.innerHTML = `
                                    <div style="margin-bottom: 15px; text-align: center;">
                                        <img src="${imageUrl}" alt="Question ${index + 1} image" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                                    </div>
                                `;
                                imageContainer.classList.remove('image-placeholder');
                            };
                            img.onerror = function() {
                                console.log(`Failed to load image for question ID: ${q.id || index}`);
                                imageContainer.style.display = 'none';
                            };
                            img.src = imageUrl;
                        }
                    }
                });
                
                container.appendChild(questionDiv);
            });

            document.getElementById('quizContent').style.display = 'block';
        }

        function updateProgress() {
            const answered = document.querySelectorAll('input[type="radio"]:checked').length;
            const total = quizData.length;
            document.getElementById('progress').textContent = `${answered} of ${total} answered`;

            // Update userAnswers in real-time
            userAnswers = {};
            quizData.forEach((q, index) => {
                const questionKey = `question_${q.id || index}`;
                const selectedRadio = document.querySelector(`input[name="${questionKey}"]:checked`);
                if (selectedRadio) {
                    userAnswers[q.id || index] = parseInt(selectedRadio.value);
                }
            });

            // Enable/disable export button based on progress
            const exportBtn = document.getElementById('exportProgressBtn');
            if (exportBtn) {
                exportBtn.disabled = answered === 0;
            }

            // document.getElementById('submitBtn').disabled = answered < total;
        }

        document.getElementById('quizForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            userAnswers = {};

            // Collect answers
            quizData.forEach((q, index) => {
                const questionKey = `question_${q.id}`;
                if (formData.has(questionKey)) {
                    userAnswers[q.id] = parseInt(formData.get(questionKey));
                }
            });

            showResults();
        });

        function showResults() {
            let correct = 0;
            const total = quizData.length;

            // Mark correct/incorrect answers
            quizData.forEach((q, index) => {
                const questionId = q.id;
                const userAnswer = userAnswers[questionId];

                // Convert correct answer to index (A=0, B=1, C=2, D=3)
                let correctAnswer;
                if (typeof q.correct === 'string') {
                    correctAnswer = q.correct.toUpperCase().charCodeAt(0) - 65; // A=0, B=1, etc.
                } else {
                    correctAnswer = q.correct;
                }

                const questionContainer = document.querySelectorAll('.question-container')[index];
                const options = questionContainer.querySelectorAll('.option');

                options.forEach((option, optIndex) => {
                    if (optIndex === correctAnswer) {
                        option.classList.add('correct');
                    } else if (optIndex === userAnswer && userAnswer !== correctAnswer) {
                        option.classList.add('incorrect');
                    }
                });

                if (userAnswer === correctAnswer) {
                    correct++;
                } else { // For incorrect questions, expand details
                    questionContainer.setAttribute('open', '');
                }
                console.log(`Q-${index}: user = ${userAnswer}, correct = ${q.correct} - ${correctAnswer}`)
            });

            const percentage = Math.round((correct / total) * 100);
            document.getElementById('finalScore').textContent = `${correct}/${total} (${percentage}%)`;

            let message = '';
            if (percentage >= 90) {
                message = 'üéâ Excellent! Outstanding performance!';
            } else if (percentage >= 70) {
                message = 'üëç Good job! Well done!';
            } else if (percentage >= 50) {
                message = 'üëå Not bad! Room for improvement.';
            } else {
                message = 'üìö Keep studying! You can do better!';
            }

            document.getElementById('scoreMessage').textContent = message;
            document.getElementById('results').style.display = 'block';
            document.getElementById('submitBtn').style.display = 'none';

            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
            
            // Quiz is completed, no longer need to prevent navigation
            quizStarted = false;
        }

        function resetQuiz() {
            document.querySelectorAll('.option').forEach(option => {
                option.classList.remove('correct', 'incorrect');
            });

            document.querySelectorAll('.question-container').forEach(container => {
                container.removeAttribute('open');
            });

            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
            });

            document.getElementById('results').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'block';
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('progress').textContent = `0 of ${quizData.length} answered`;

            userAnswers = {};
            quizStarted = false;

            // Show set selection again
            document.getElementById('setSelection').style.display = 'block';
            document.getElementById('quizContent').style.display = 'none';

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Confirmation Dialog Functions
        function showConfirmationDialog(message, title = '‚ö†Ô∏è Unsaved Progress') {
            document.getElementById('dialogTitle').textContent = title;
            document.getElementById('dialogMessage').textContent = message;
            document.getElementById('confirmationDialog').style.display = 'flex';
        }

        function hideConfirmationDialog() {
            document.getElementById('confirmationDialog').style.display = 'none';
            pendingNavigation = null;
        }

        function getProgressJson() {
            const progressData = {
                quizSet: quizData.id,
                userAnswers: userAnswers,
                timestamp: new Date().toISOString()
            };
            return JSON.stringify(progressData, null, 2);
        }

        function showExportDialog() {
            const textArea = document.getElementById('exportJsonText');
            textArea.value = getProgressJson();
            document.getElementById('exportDialog').style.display = 'flex';
            // textArea.scrollTop = 0; // move caret to start for usability
        }

        function hideExportDialog() {
            document.getElementById('exportDialog').style.display = 'none';
        }

        function exportQuizProgress() {
            const jsonText = getProgressJson();

            const blob = new Blob([JSON.stringify(progressData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quiz-progress-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Only hide dialog and navigate if this was called from the dialog
            if (document.getElementById('confirmationDialog').style.display === 'flex') {
                hideConfirmationDialog();
                if (pendingNavigation) {
                    window.location.href = pendingNavigation;
                }
            }
        }

        function hasUnsavedProgress() {
            return quizStarted && Object.keys(userAnswers).length > 0;
        }

        // Event Listeners for Dialog Buttons
        document.getElementById('exportBtn').addEventListener('click', exportQuizProgress);
        // Export dialog events
        document.getElementById('exportDownloadBtn').addEventListener('click', function() {
            exportQuizProgress();
        });
        document.getElementById('exportCopyBtn').addEventListener('click', async function() {
            const text = document.getElementById('exportJsonText').value;
            try {
                await navigator.clipboard.writeText(text);
                this.textContent = 'Copied!';
                setTimeout(() => { this.textContent = 'Copy'; }, 1200);
            } catch (err) {
                alert('Copy failed. You can manually select and copy the text.');
            }
        });
        document.getElementById('exportCloseBtn').addEventListener('click', function() {
            hideExportDialog();
        });
        document.getElementById('stayBtn').addEventListener('click', hideConfirmationDialog);
        document.getElementById('leaveBtn').addEventListener('click', function() {
            hideConfirmationDialog();
            if (pendingNavigation) {
                window.location.href = pendingNavigation;
            }
        });

        // Prevent accidental navigation
        window.addEventListener('beforeunload', function(e) {
            if (hasUnsavedProgress()) {
                e.preventDefault();
                e.returnValue = 'You have unsaved quiz progress. Are you sure you want to leave?';
                return e.returnValue;
            }
        });

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(e) {
            if (hasUnsavedProgress()) {
                e.preventDefault();
                showConfirmationDialog('You have unsaved quiz progress. Are you sure you want to navigate away?');
                // Push the current state back to prevent navigation
                history.pushState(null, null, window.location.href);
            }
        });

        // Handle refresh
        window.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                if (hasUnsavedProgress()) {
                    e.preventDefault();
                    showConfirmationDialog('You have unsaved quiz progress. Are you sure you want to refresh the page?');
                }
            }
        });

        // Handle visibility change (when user switches tabs or minimizes browser)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden' && hasUnsavedProgress()) {
                // User is leaving the page, but we can't prevent it completely
                // The beforeunload event will handle the confirmation
            }
        });

        // Prevent navigation through links when there's unsaved progress
        document.addEventListener('click', function(e) {
            if (e.target.tagName === 'A' && hasUnsavedProgress()) {
                e.preventDefault();
                pendingNavigation = e.target.href;
                showConfirmationDialog('You have unsaved quiz progress. Are you sure you want to navigate away?');
            }
        });
    </script>
</body>
</html>